name: Publish Packages

run-name: Publish package ${{ github.event.inputs.package  }} by @${{ github.actor }}

permissions:
  contents: write # allow committing/tags if you need it
  packages: write # allow pushing packages using GITHUB_TOKEN

on:
  workflow_dispatch:
    inputs:
      package:
        description: "Package path (relative to repo root)"
        required: true
        type: choice
        options:
          - dotnet/Common.Observability
          - npm/common-observability
      version:
        description: "Version to publish (e.g. 1.0.1)"
        required: true
        type: string

jobs:
  decide:
    runs-on: ubuntu-latest
    outputs:
      type: ${{ steps.detect.outputs.type }}
    steps:
      - uses: actions/checkout@v4
      - id: detect
        run: |
          pkg="${{ github.event.inputs.package }}"
          # Grab the first path segment (before the first /)
          top="${pkg%%/*}"

          if [ "$top" = "dotnet" ]; then
            echo "type=dotnet" >> "$GITHUB_OUTPUT"
          elif [ "$top" = "nest" ] || [ "$top" = "npm" ] || [ "$top" = "node" ]; then
            echo "type=npm" >> "$GITHUB_OUTPUT"
          else
            echo "type=unknown" >> "$GITHUB_OUTPUT"
            exit 1
          fi

  call-dotnet:
    if: needs.decide.outputs.type == 'dotnet'
    needs: decide
    uses: ./.github/workflows/publish-dotnet.yml
    with:
      package: ${{ github.event.inputs.package }}
      version: ${{ github.event.inputs.version }}

  call-npm:
    if: needs.decide.outputs.type == 'npm'
    needs: decide
    uses: ./.github/workflows/publish-npm.yml
    with:
      package: ${{ github.event.inputs.package }}
      version: ${{ github.event.inputs.version }}
